# 作業日誌３（走行会後、決勝まで）

## 走行会データ解析１　2024.10.14
実車から吸い上げた、rosbagのデータを展開。

実車のaichallengeフォルダ以下のファイルをすべて吸い上げていたので、github上のsrcと比較し、
workspaceのsrcに入っていたものが同一であることを確認。

続いて、rosbagのtopic調査。適当にtopicを選んだところ、例外エラーが出て読めない。
`tier4_〜`や`autoware_adapi_v1〜`のtopicは読めないようで、それらを避けて、読み取る。

読み取ったデータと、Yuさんの現地走行時のメモを対応させて、下記のファイルにまとめた。
`1011走行会rosbag.fods`

調査中、slackで、**操舵について、0.35rad/sec以下の制限がかかった**という情報あり。この情報から、シミュレータでの操舵角度制限処理につながる。
また、このときの投稿画像で、操舵指令値と操舵の現在値を示すtopicも示されていたので、以後、この2つのtopicをデータ解析に使用する。
***こういう情報共有がとても助かります。***

自分の思いついたToDoを上記bookの１シートにまとめる。

## 走行会データ解析２ 2024.10.15
rosbagに含まれている、他のtopicについて、どのような情報が含まれているのか、読み取れるtopicについて、すべて調査する。
調査結果を、
`1011走行会rosbag.fods`の`topic`シートにまとめた。
同じようなデータが複数あって、全topicを参照する必要はなさそうなことがわかった。

この日の気付きは下記の通り。

- gnss, localizationのデータは実車が動いているのに止まることがある。localizationの方は、gnssが止まっていても少し先に動いている。
- 周回成功時にはgnss, localizationが止まることはない。
- 衝突前に必ず、gnss, localizationが止まるわけでもない。
- 操舵については、途中から、ルックアヘッドポイントへの操舵を諦めてしまっているように見える。

## 走行会データ解析３　2024.10.16
前日の４つ目の気づきの操舵を諦めてしまっているように見える件、
調査の結果、操舵が戻りきらずに壁への激突が発生していることが判明。
操舵角速度の制限が原因と思われる。コーナーの速度の制限もそれが原因と想定される。

## 走行会データ解析４　2024.10.17
Slackで、運営からの投稿で、最大舵角が32度と書かれていた。
もともとの仕様は80度だった。
どうやら±40度を80度と記載していたと想定。それが、今回、最大舵角を±32度にしたということらしい。
10/19にslackで問い合わせた結果、32度以上操舵を切ることもできるが、32度以上になると指令値に対して非線形な動きになるということで、制限をかけたとのこと。

## 走行会データ解析５ 2024.10.19
slackでの他チームからの投稿で自動運転中かどうかをtopicから判別する手段がわかり、
kinematicとgnssとの差が大きいところは手動走行中であることが判明。
調査対象を自動運転中に絞ることができて、データ解析の効率を上げることができた。
***他チームからの情報共有ありがたいです。***

rosbag調査により下記が判明
- 高速走行時は操舵が、指令値に全く追従できていない。逆に、走行成功時は、操舵が指令値に追従している。これは、0.35rad/s以下という制約によるものと思われる。したがって、コーナーの速度制限は、Mustになる。
- 操舵に関する測定値が真逆になっていたり、gnssのデータから測定されているposeが更新されないなどの異常データがあったが、それらは、手動走行時のもので、自動走行時には、最初の失敗走行時を除いて、大きなズレは認められなかった。つまり、通常時は、それらの信号は遅延はあるものの、信じて良さそう。

そこで、**シミュレータで操舵角速度制限をかける**ことで、実車の挙動をシミュレータで再現できるのでは？と考えた。変更対象のソースファイルの調査が必要。

シミュレータと実車の違いは、他に、遅延があり、遅延は、操舵とGNSSの２つ。それらの２つの遅延がシミュレータで再現されているかを調べる必要がある。

また、この日slackで運営へ３点質問した。
1. 走行会で判明したGNSS信号停止の事例を説明しつつ、imu_gnssの異常信号の扱いについて質問・・・回答：異常信号は通常扱いで、そのような場合も競技は続行。
2. gnssの信号の異常値検出手段について・・・回答：covarianceでわかるが、更新されない場合の対処はチームで考えて。
3. シミュレータと実機との違いについて、最大操舵角の確認とその他の違いについて・・・回答：最大操舵角が32度であることと、その理由説明。

***Q1の回答が辛かった〜。GNSSで自己位置推定できなくても、競技続行ですか・・・***

## 実機シミュレータづくり１ 2024.10.20
plotjuggerでのデータ調査と、ソースコード調査。

- `kinematic`と`gnss`との時間差は500ms
- `control/command` → `vehicle/status/.../steering_tire_angle`との差は、約200ms

操舵の指令値の出力周期は、plotjuggerから、30msであることを確認。
- `aichallenge_awsim_adapter_launch.xml`に、`teer_delay_sec`があり、200msが設定されている。
`actuation_cmd_converter.cpp`の中で、操舵指令値を200ms遅延して出力している。
- 操舵指令値については、35degree でclampしている。運営の発表では32degreeなので、ミスと想定して、32degreeでclampするよう変更。

下記のファイルを調査するも、操舵とは関係なかった。自己位置に関係しそうで、３つ目のファイルに遅延原因がありそう。
- gyro_odometer_core.cpp
- imu_corrector_core.cpp
- imu_gnss_poser_node.cpp

操舵制限処理を`actuation_cmd_converter.cpp`に追加する。ChatGPTに聞きながら、現在の操舵角を求めるためにsubscriptionを追加した。
走行させて、plotjugglerで確認しながら、操舵角度制限用のパラメータ値を追い込む。
テスト中に挙動がおかしくなる。パラメータの値と車両の挙動が対応しなくなった。
しばらく悩んだが、一旦dockerから抜けて、また戻ったら、正常になった。
何かが原因で操舵のactuator用の出力が、操舵角指令値に追従しなくなっていた。これは、この後ずっと解決しない。回避策は、一旦dockerを抜けて立ち上げ直すこと。

0.2sの遅延はもともと入っている処理で実現されており、この日に追加した操舵角度制限も問題なく動作した。

***いわささんが、この日、３画面動悸した動画を作成。かっこいい！***

## 実機シミュレータづくり２ 2024.10.21
前日の操舵角度制限処理の妥当性検証を続ける。
plotjuggerでグラフの詳細を見ながらパラメータ調整＆検証。

検証していく中で、シミュレータの操舵指令値が小さく、実走行時の操舵指令値が倍以上の値になっていることがわかり、それは、すなわち、実機が曲がりにくいことがわかった。（前夜祭で聞いていたとおり）
それをシミュレータでどう再現するか。まず、ホイールベースを伸ばしてみた。確かに曲がりにくくなったが、時速15km/hでも走れなくなったり、
調整が難しい。15km/hで走れて、かつ、20km/hで走れない（曲がりきれない）、そのようなホイールベースの値は少しやってみただけだが、見つけられなかった。

ホイールベースを伸ばす案は、だめ、という結論になり、ゲインを調整してみることにした。

## 実機シミュレータづくり３ 2024.10.22
曲がりにくさを考慮して、Actuator指令値を、指令操舵角の半分しか出力しないようにした。
さらに、操舵角速度制限も、合わせて半分の値にした。

検証・・・15km/hでは一周できたが、20km/hでは壁にぶつかった。　完成！

試しに操舵ゲインを上げてみた。面白い。操舵ゲインを上げると操舵が戻り切らない。積分が効いているように感じた。

`onverter.param.yaml`に`ros__parameters` とあり、`steer_pid:kp, ki, kd`といったパラメータがあり、これかな？
と思って、ki:15.0　になっているので、これを0にしてみたが・・・。動きは変わらずだったので、関係なさそう。

***ともさんが、決勝用地図の分割調査開始***

## 操舵角による速度制限追加 2024.10.23
実機シミュレータづくりに飽きたので、操舵角による速度制限を入れてみた。
コーディングミスやいつものDocker不具合などで手間取るも、なんとか完成。

***ともさんが、直線を30km/hに設定したmapを作成***

## BSフジTV取材 ＆ 走行会データ解析６ 2024.10.24
TV取材中、前日にともさんが、作成されたMapを導入して、そのMapで操舵角による速度制限付きで走らせた。

取材終了後、走行会のデータ解析でぶつかった原因などを再調査。気づきは下記。

- コーナ走行時のkinematicsの軌跡と、GNSSの軌跡を比較。操舵角が大きくなったときに両者のズレが大きくなっており、カーブの内側がGNSS、外側がkinematic。これは何を意味しているのだろう？
 - 駆動輪の滑りにより、大きく進んでいると想定されているのだろう。 だから、操舵角によって、速度を落とさないと、正しく自己位置推定できないのではないか。
- 実車の走行速度が目標速度に達していない不思議・・・比例制御なので、偏差が残っているものと想定したが、アクセルオフで-0.3の加速度指示があるのを思い出し、おそらくそのためだろう。
- ３本目の走行で右に操舵した原因は、ルックアヘッドポイントが、全然先にあったことである。これは、なにかおかしい。
- シミュレータでの走行時、目標レーンの右側にいるのに、操舵を左に切らないのが不思議。

***ともさんが、分割ポイントのずらし方をマスター、コーナー手前での15km/hへの速度ダウンや走行経路のイン攻めなど対応。とても大変そう。***

## simple_pure_pursuit改造１ 2024.10.25
アクセルのゲインを、1.0から100.0に変更する。Maxで加減速できるように。
操舵角による速度制限をONし、走行速度を35km/hに設定した。
操舵に微分制御を追加し、ゲインは0.5とした。

走らせてみると、ルックアヘッド距離が長すぎてコーナ内側壁面にぶつかる。

ルックアヘッド距離をカットアンドトライで調整。0.5とした。

操舵ゲインについても調整。４を設定すると第1コーナーで曲がりすぎる。
操舵角による速度制限用パラメータ、`v_limit_angle`を調整してみる。15degが良さそう。

気づき：
- 操舵ゲインをおおきく(=4)にしてみたら、第１コーナーで曲がりすぎが発生。
PlotJugglerで調べてみると、操舵指令値がゲインにより大きい指示値になっていて、指示値が戻り始めていても、現在の角度より切る指令なので、戻さないといけないのに、そのまま悪い方へ切り続けていることがわかる。すなわち、操舵ゲインは大きくすればよいものではない。


***ともさんが、私のソースコードを使って、作成したMapを走らせてみる評価を開始***

## simple_pure_pursuit改造２ 2024.10.26
運営コードのバグ修正。ホイールベスの中心座標の算出式の誤りを、ChatGPTに教わって、修正した。

未来自己位置予測処理(x, y)を追加。0.7s後の位置予測をするようにしたら、きれいに、経路に追従するようになった。

デバッグ：`findNearestIndex`の算出に未来位置を使わなければならないのに、現在位置で行っていた不具合を修正。

また、操舵制御に積分項があると想定していたことについて、積分項ではなく、車体の向きが原因だった。車体の向きが積分項と同じ影響をもたらしていた。
そのため、未来自己位置予測処理に、車体の向き(yaw)を追加して、x, y, yawを予測することで、追従性がさらによくなった。

## simple_pure_pursuit改造３＆パラメータ調整 2024.10.27
前日のソースコードでは、ルックアヘッドポイント算出が現在位置のままで誤っていたので、未来自己位置でルックアヘッドポイントを算出するように修正した。
操舵速度制限について、再計算して検証。
パラメータも調整。
すると何故か、操舵が振動して真っ直ぐに走らなくなった。
操舵の振動がなくならない。

と、ここで、開発環境壊れる。原因は、SSDの空き容量が少なくなったので、`autoremove`を実行して、docker imageのフォルダがデフォルトになってしまったから。
docker imageのフォルダを正しいフォルダに変更して、復旧した。ホッとした。

２つのルックアヘッドポイントを追加。
なぜか、操舵の振動がなくなった。

以後、ルックアヘッドポイント用パラメータを調整して、一周走れるかどうか確認。
最終的に、`predict_time`を0.4sに設定することで一周できるようになった。

**未来自己位置予測と２つのルックアヘッドポイントがないと、追従性の悪い操舵では一周できない**

***ここで、Yuさんが、ekf_localizerのパラメータチューニングにチャレンジしていた。が、うまく行かず断念。続けて地図編集にトライし、成功！　すばらしい！***

## simple_pure_pursuit改造４ 2024.10.28
***ともさんが、Yuさん作成のMapを使って速度チューニング。ラップタイム 74.4s　なお、Lanelet ID=2256がつながっていないことを報告***
Mapの指令速度を、定数倍する処理を追加。
1.3倍速で、ラップタイム61.5s

ChatGPTに教わって、必要なtopicを受信するsubscript1を追加できたことにより、GNSS異常検出機能追加完了。

## プレゼンネタ作成１ 2024.10.29
`20241029.md`に今回の取り組みについて記載。

## 大会準備１ 2024.10.30
fork sinkして、mergeした。
大会本番が延期になった。
slackのquestions_質問を読む。実車では、submitフォルダだけが上書き可能。他を上書きしてはいけない。

***Yuさんが、Lanelet ID=2256の分割にチャレンジし、いい感じに分割できたバージョン完成***

## プレゼンネタ作成２ 2024.10.31
`20241029.md`にソースコードなどを追加。
`パラメータまとめ.md`を作成。

## 情報収集１ 2024.11.1
全然関係ないけど、1週間以上前に届いていたスマホ用のバッテリ交換を実施。
ハマった場合に備えて長時間取れるタイミングのこの日に交換を実施。ビビりながら交換したが、一回で交換成功！　web記事のおかげ。

アドベントカレンダーを見て、情報収集。下記が目に止まる。
- ノードパラメータ変更
- 初期位置設定


## 最適経路への道１ 2024.11.2
***ともさんが、Yuさんが分割したMapに速度を設定。1.3倍速で走破。経路再編集してlaptime 55.5s。ゴール地点の座標を修正***

roborovskyさんの記事から、最適経路生成をやってみた。
経路生成できるソースも提供されていたので、実行してみたらあっさり出来上がった。

## 最適経路への道２&バグ修正 2024.11.3
走行経路の論文を見てみる。面白そうだが、式が難しすぎて理解できない。

osmファイルの編集方法を調べてみる。
とっても大変。
ともさんにお聞きして、多すぎるポイントを減らしたMapを作り、そちらで編集。

走らせながら、パラメータ調整。ルックアヘッド距離やゲインを調整。
1.8倍速で、ラップタイム44.301

ここで、plotjugglerのグラフから、ルックアヘッドポイントの座標が時々おかしいことを発見。
Mapがおかしいのでは？とdiscordに投稿したが、結局ソフトの不具合でした。ルックアヘッド距離の算出時の速度が、
現在速度ではなく、目標速度になっていたという、潜在不具合。

Map編集して、操舵角による速度制限を加え、30km/hで走れるようになって、ラップタイム43.162s

## 最適経路への道３ 2024.11.4
操舵角による速度制限について、指令値と実測値とのギャップから算出する。
あるいは、現在の操舵角と、未来の指令値との差から算出する。というアイデアを実装。

roborovskyさんの記事にあった、最適経路図を参照して、Map編集。ラップタイム41.481s　
このときのコースは、かなり攻めたコースだった。

## simple_pure_pursuit改造５ 2024.11.5
Parameterの動的設定に挑戦。
とっとこちゅら太郎さんの記事を参考に実装。すぐに動いたが１つかつ１度しかパラメータを変更できない。
上記記事のリンク先の記事で、複数のパラメータを変更できる手段の実装方法をまねて、作業実施した。
結果として成功。

## 最適経路への道４ 2024.11.6
気になっていた、実機での操舵遅延処理を確認した。実機のsystem側のソースには、遅延処理は含まれていなかった。
結果として、0.2s遅延は実機の遅延をシミュレータで再現しているということになった。すなわち、未来自己位置推定が有効である。悪影響にはならない。

また、動的パラメータ変更のためのscriptについても、とっとこちゅら太郎さんの記事を参考に作成した。

Mapを編集して、壁までの距離をできるだけ離した。11.7 3:00すぎまで頑張った。