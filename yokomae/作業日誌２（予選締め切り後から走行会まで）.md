#作業日誌２（予選後、走行会まで）

##手動シミュレータ１　2024.9.16
予選大会が終わって、次に何をしよう　という中だるみ。
いわささんが、ジョイスティックでの手動走行用ソフトを上げていたので、遅まきながら、
Handle型Controller:Logicoolの`GeForce Pro`を押し入れから引っ張り出して、
セットアップ。
`jstest-gtk`を使って調整するも、`GeForce Pro`からの信号が全く入ってこない。ググったり、ChatGPTに聞いたりして色々試すも状況変わらず。

と、PCに挿している、`GeForce Pro`のUSBを抜き差ししたら、問題なく通信できた。う〜〜〜〜ん。

ところが、調整の方はうまく行かない。

##手動シミュレータ２ 2024.9.17
いわささんの書き込みから、axis(3)などを変更していく。直接、`accel`と`handle`に`joystick`からの入力を入れてみるが、
シミュレータ画面で、`handle`が動かない。ノーマライズがうまく行っていないようで。
数値を詳しく調べると、`joystick`からは、正規化済みの情報が入ってくることがわかり、変換を正しく行ったところ、
Controllerでのハンドル操作に対応して、シミュレータ画面でもハンドルが動くようになった。
一方、アクセルを踏んでも、進まなかった。

##手動シミュレータ３ 2024.9.18
定例ミーティングで、ともさん、いわささんと画面共有しながら状況説明。
ギアがパーキングに入っていることがわかった。
ギアについては、下記のファイルに定義があった。
```"/autoware/install/autoware_auto_vehicle_msgs/local/lib/python3.10/dist-packages/autoware_auto_vehicle_msgs/msg/_gear_command.py", line 360, in command```

しかしながら、バックギア（REVERSE）の定義がない。ブレーキについても、負の加速度が加わるだけで、ブレーキらしくない挙動である。
結局、ブレーキと、バックについては、わからなかった。
前進しかできず、ブレーキの効きの悪いシミュレータで、とても、レース走行できる状況にはならなかった。

##LT会 自動運転AIチャレンジ2024予選お疲れ様＆表彰式前夜祭 2024.9.19
運営　田中さんのプレゼンから、GNSS信号の0.5s遅延、実車が曲がりにくい（後輪がディファレンシャルギアでない）ことといった情報を得る。
また、自己位置推定が肝とも。

##事前走行会に向けて１ 2024.10.2
公式でupdateされている、実車用のコードをclone。
シミュレータ用途の違いを調査。下記の変化点があった。
`aichallenge_awsim_adapter`フォルダが追加されている。

下記のフォルダで内容の変更されているファイルがいくつかあった。
`aichallenge_submit_launch`
`aichallenge_system_launch`

##事前走行会に向けて２ 2024.10.3
引き続き、変化点調査。
`pub_raw_cmd` node が増えているが、これが何なのかわからない。

##事前走行会に向けて３ 2024.10.4
操舵への微分制御処理などを追加、デバッグ。
`steering_tire_angle_gain`を1.0から2.0に変更したら追従性が良くなった。
`steering_diff_gain`(微分用係数)は、0.5とした。1.0にしても、上記 angle_gainの効果のほうが大きかった。

##事前走行会に向けて４ 2024.10.5
チャレンジクラブの`main`ブランチに、公式のものをmergeしようとしたが、うまくできないので、諦めて、Takomaronローカルで作る。

実車への対応として、センサ入力値の誤差などの異常値を弾くことが必要と考え、自己位置推定処理をどこで行っているのか、ソースコードを調査。
SimplePursuitでodometry_メッセージを受信して自己位置として扱っていることを理解。
`pose_additional_delay`パラメータで、自己位置のdelay timeが設定されているが、このパラメータを使っているソースコードがない。
`ekf_localizer`というところで、自己位置推定しているようだが、このソースがない。
ないないづくし・・・

`raw_control_cmd`が、`AckermannControlCommand`として発行されているがどう使われているかわからない。
`pub_raw_cmd_`, `output/raw_control_cmd`が追加されているが、これらもよくわからない。

accel, brake, steerのMapping tableがあるようなので、そのtableのフォーマットを理解する必要がある。そのためにまず、テーブルファイルを探すこととする。

一方、GNSSが0.5sの遅延があるということから、むだ時間のあるシステムでの制御問題になり、どうしたものだろうと頭を抱える。


##事前走行会に向けて５ 2024.10.6

mapの場所を見つけた。下記にあった。
```aichallenge-2024/aichallenge/workspace/src/aichallenge_submit/aichallenge_submit_launch/data```
accel_map.csv, brake_map.csv, steer_map.csvの３つがあるが、steer_map.csvはどのファイルからも参照されていないため、
使われていないようである。
accel, brakeについては、テーブルの構造がわからないが、ペダル踏み量（行）と速度（列）とのテーブルになっているようで、pedal踏み量は、0.0-1.0に正規化されており、
速度は、0.0-10.0に正規化されているようだ。その推定のもと、わかったことは下記の通り。
・速度にかかわらず、ペダル踏み量に対して同じ値が設定されている。つまり、このテーブルは実機に合わせた調整がまだ行われていないと思われる。
・brakeペダル開放、accelペダル開放時、-0.3(Max 1.0で正規化)の加速度が設定されている。すなわち、速度維持には、加速度のオフセットが必要そうである。
・brakeペダル全踏み時、-2.5なので、加速の2.5倍の加速度で減速する。

mapに関連するtopicとして下記があるが、それらの発行者、購読者が誰なのか、ソースが存在せず、追いきれなかった。

ということで、mapの調整より、自己位置推定を進めるほうが大事であるということになった。

走行会に向けて、運営側のソフト更新なども慌ただしくなっている。map定義にバグあり(10/6 18:32)とのことで、その反映を行った(10/6 21:08)。

0.5s遅延の影響を確認してみる。速度30km/hでは、0.5sで、4.167mも進む。絶対ぶつかる！
走行会では基礎情報を集める必要がありそう。速度vからの加速や減速、速度vでの操舵角増減時の応答性など。


##事前走行会に向けて６ 2024.10.7

PlotJugglerで運営が公開している実機のデータを覗いてみる。
GNSSのcovarianceについては、停車中は230-250、走行中は141くらい。300以下なら信頼できそう。

steering_tire_angleについて、指令値とセンサの値は、0.1s程、センサの値が指令値から遅延している。

accelerationとlongitudinal_velocityには遅延はなしと判断できる。


##事前走行会に向けて７ 2024.10.9

どはまる。

現地から、自宅PCにリモートアクセスできるように、chrome desktopをインストールしたところ、
「カラープロファイルを作成するには認証が必要です」という表示が頻繁に表示されるようになって、
ほぼ、操作不能になる。wifiもおかしくなった。

色々対応して、ほぼ復旧したが、気持ち悪いので、chrome desktopもついでに削除した。

##事前走行会に向けて８ 2024.10.10
東京へ移動。到着後、公式のupdateをmerge。公式の手順に従って、ARP???やRemote SSHを追加。

##事前走行会 2024.10.11
操舵角と、実際の車体の旋回特性を確認しておこうと、下記のファイルに操舵リミットを追加した。
`simple_pure_pursuit.cpp`
`reference.launch.xml`

操舵リミットパラメータは下記
`use_steer_lmt`
`steer_lmt`

結局、上記のパラメータを使って確認する余裕は全くなし。
走行プログラムは、運営から提供されたものをそのまま使用。
目標速度、操舵ゲイン、ルックアヘッド距離を変更しつつ、走行させて、rosbagを収集した。

横前は、端末操作をYuさんにお願いして、実車の動きをあちこち移動しながら、走りながら、観察。
Yuさんは、端末オペレータとして目標速度、操舵ゲイン、ルックアヘッド距離を設定。（実機への転送操作など、とてもスムーズ。横前は見守ることしかできません(汗)）
いわささんは、中継/通信環境セットアップ後、Yuさん横で待機。
赤松さんは、SD(セーフティドライバー)への連絡担当としてのSO(セーフティオペレーター)として、壁に激突しまくる実車を見守る。
清水さん、ともさんは走行状況撮影。・・・この動画、決勝に向けてのデータ解析でとても役立ちました。データだけでは実際の動きが全然わからないので。

皆さんの連携、すばらしいです。
運営の皆様、たくさんぶつけてごめんなさい。コースの復旧、大変お疲れ様でした。

走行会後の、食事会兼反省会で、色々意見出し。
実車の走行のおかしい原因は、駆動輪で移動距離を求めていそうだから、滑りが発生して、それが主な原因だろうという結論になった。

後日のデータ解析でわかることだが、原因は下記であった。
・GNSSの信号途切れによる自己位置ロス。
・ルックアヘッドポイントが、隣のコースに残っていた。（これも、自己位置ずれ）
・走行開始時の自車の姿勢が、リアルの姿勢（見た目はコースと並行）と、ekfから算出された向き（コースに対して右or左向きなど）が異なっていた。